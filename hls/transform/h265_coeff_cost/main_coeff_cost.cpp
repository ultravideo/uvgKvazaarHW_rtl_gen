/*****************************************************************************
 * This file is part of uvgKvazaarHW.
 *
 * Copyright (c) 2025, Tampere University, ITU/ISO/IEC, project contributors
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without modification,
 * are permitted provided that the following conditions are met:
 *
 * * Redistributions of source code must retain the above copyright notice, this
 *   list of conditions and the following disclaimer.
 *
 * * Redistributions in binary form must reproduce the above copyright notice, this
 *   list of conditions and the following disclaimer in the documentation and/or
 *   other materials provided with the distribution.
 *
 * * Neither the name of the Tampere University or ITU/ISO/IEC nor the names of its
 *   contributors may be used to endorse or promote products derived from
 *   this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
 * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION HOWEVER CAUSED AND ON
 * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 * INCLUDING NEGLIGENCE OR OTHERWISE ARISING IN ANY WAY OUT OF THE USE OF THIS
 ****************************************************************************/

#include "global.h"

#define SCAN_DIAG 0
#define SCAN_HOR 1
#define SCAN_VER 2
#define SCAN_DEBUG 3

static const unsigned CG_COUNT = MAX_WIDTH * MAX_WIDTH / 16;

// Full fits array, 15 bits decimal accuracy
static const ac_fixed< 14 + 15, 14, true > fits[4][6] = {{4452.0086813, 0.1706842, -4.3502404, -2.1188156, 7.7211520, 0.0370893},
                                                         {1098.9114759, 0.2115117, -4.2989654, -1.7549422, 5.9533124, 0.0847259},
                                                         {275.6710972, 0.3146363, -4.3033721, -1.7292601, 2.4446289, 0.2775454},
                                                         {57.0892748, 0.4917267, -3.3880683, -2.2381652, 0.0, 1.0528123}};

// Fits with one less bit accuracy and missing first value.
// Total bit width is 18 bits so it fits to DSPs
static const ac_fixed< 4 + 14, 4, true > dfits[4][5] = {{0.1706842, -4.3502404, -2.1188156, 7.7211520, 0.0370893},
                                                        {0.2115117, -4.2989654, -1.7549422, 5.9533124, 0.0847259},
                                                        {0.3146363, -4.3033721, -1.7292601, 2.4446289, 0.2775454},
                                                        {0.4917267, -3.3880683, -2.2381652, 0.0, 1.0528123}};

// Convert above tables to integer, rounding down
#define FITS_TO_INT(a) (((a) * (1 << 15)).to_int())
#define DFITS_TO_INT(a) (((a) * (1 << 14)).to_int())

static two_bit get_scan_order(const uint_6 intra_mode, const two_bit depth) {
  // Scan mode is diagonal, except for 4x4+8x8 luma and 4x4 chroma, where:
  // - angular 6-14 = vertical
  // - angular 22-30 = horizontal

  if (depth >= 2) {
    if (intra_mode >= 6 && intra_mode <= 14) {
      return SCAN_VER;
    } else if (intra_mode >= 22 && intra_mode <= 30) {
      return SCAN_HOR;
    }
  }

  return SCAN_DIAG;
}

uint_10 scan_i(const uint_10 cord, const two_bit size, const two_bit scan_mode) {
  static const uint_10 offset[4] = {340, 84, 20, 4};

  static const uint_10 inv_g_sig_last_scan_0[1364] = {
      0,    2,    1,    3,    0,    2,    5,    9,    1,    4,    8,    12,   3,    7,    11,   14,   6,   10,   13,  15,  0,   2,   5,   9,   32,  34,  37,  41,  1,   4,   8,   12,  33,  36,
      40,   44,   3,    7,    11,   14,   35,   39,   43,   46,   6,    10,   13,   15,   38,   42,   45,  47,   16,  18,  21,  25,  48,  50,  53,  57,  17,  20,  24,  28,  49,  52,  56,  60,
      19,   23,   27,   30,   51,   55,   59,   62,   22,   26,   29,   31,   54,   58,   61,   63,   0,   2,    5,   9,   32,  34,  37,  41,  80,  82,  85,  89,  144, 146, 149, 153, 1,   4,
      8,    12,   33,   36,   40,   44,   81,   84,   88,   92,   145,  148,  152,  156,  3,    7,    11,  14,   35,  39,  43,  46,  83,  87,  91,  94,  147, 151, 155, 158, 6,   10,  13,  15,
      38,   42,   45,   47,   86,   90,   93,   95,   150,  154,  157,  159,  16,   18,   21,   25,   64,  66,   69,  73,  128, 130, 133, 137, 192, 194, 197, 201, 17,  20,  24,  28,  65,  68,
      72,   76,   129,  132,  136,  140,  193,  196,  200,  204,  19,   23,   27,   30,   67,   71,   75,  78,   131, 135, 139, 142, 195, 199, 203, 206, 22,  26,  29,  31,  70,  74,  77,  79,
      134,  138,  141,  143,  198,  202,  205,  207,  48,   50,   53,   57,   112,  114,  117,  121,  176, 178,  181, 185, 224, 226, 229, 233, 49,  52,  56,  60,  113, 116, 120, 124, 177, 180,
      184,  188,  225,  228,  232,  236,  51,   55,   59,   62,   115,  119,  123,  126,  179,  183,  187, 190,  227, 231, 235, 238, 54,  58,  61,  63,  118, 122, 125, 127, 182, 186, 189, 191,
      230,  234,  237,  239,  96,   98,   101,  105,  160,  162,  165,  169,  208,  210,  213,  217,  240, 242,  245, 249, 97,  100, 104, 108, 161, 164, 168, 172, 209, 212, 216, 220, 241, 244,
      248,  252,  99,   103,  107,  110,  163,  167,  171,  174,  211,  215,  219,  222,  243,  247,  251, 254,  102, 106, 109, 111, 166, 170, 173, 175, 214, 218, 221, 223, 246, 250, 253, 255,
      0,    2,    5,    9,    32,   34,   37,   41,   80,   82,   85,   89,   144,  146,  149,  153,  224, 226,  229, 233, 320, 322, 325, 329, 432, 434, 437, 441, 560, 562, 565, 569, 1,   4,
      8,    12,   33,   36,   40,   44,   81,   84,   88,   92,   145,  148,  152,  156,  225,  228,  232, 236,  321, 324, 328, 332, 433, 436, 440, 444, 561, 564, 568, 572, 3,   7,   11,  14,
      35,   39,   43,   46,   83,   87,   91,   94,   147,  151,  155,  158,  227,  231,  235,  238,  323, 327,  331, 334, 435, 439, 443, 446, 563, 567, 571, 574, 6,   10,  13,  15,  38,  42,
      45,   47,   86,   90,   93,   95,   150,  154,  157,  159,  230,  234,  237,  239,  326,  330,  333, 335,  438, 442, 445, 447, 566, 570, 573, 575, 16,  18,  21,  25,  64,  66,  69,  73,
      128,  130,  133,  137,  208,  210,  213,  217,  304,  306,  309,  313,  416,  418,  421,  425,  544, 546,  549, 553, 672, 674, 677, 681, 17,  20,  24,  28,  65,  68,  72,  76,  129, 132,
      136,  140,  209,  212,  216,  220,  305,  308,  312,  316,  417,  420,  424,  428,  545,  548,  552, 556,  673, 676, 680, 684, 19,  23,  27,  30,  67,  71,  75,  78,  131, 135, 139, 142,
      211,  215,  219,  222,  307,  311,  315,  318,  419,  423,  427,  430,  547,  551,  555,  558,  675, 679,  683, 686, 22,  26,  29,  31,  70,  74,  77,  79,  134, 138, 141, 143, 214, 218,
      221,  223,  310,  314,  317,  319,  422,  426,  429,  431,  550,  554,  557,  559,  678,  682,  685, 687,  48,  50,  53,  57,  112, 114, 117, 121, 192, 194, 197, 201, 288, 290, 293, 297,
      400,  402,  405,  409,  528,  530,  533,  537,  656,  658,  661,  665,  768,  770,  773,  777,  49,  52,   56,  60,  113, 116, 120, 124, 193, 196, 200, 204, 289, 292, 296, 300, 401, 404,
      408,  412,  529,  532,  536,  540,  657,  660,  664,  668,  769,  772,  776,  780,  51,   55,   59,  62,   115, 119, 123, 126, 195, 199, 203, 206, 291, 295, 299, 302, 403, 407, 411, 414,
      531,  535,  539,  542,  659,  663,  667,  670,  771,  775,  779,  782,  54,   58,   61,   63,   118, 122,  125, 127, 198, 202, 205, 207, 294, 298, 301, 303, 406, 410, 413, 415, 534, 538,
      541,  543,  662,  666,  669,  671,  774,  778,  781,  783,  96,   98,   101,  105,  176,  178,  181, 185,  272, 274, 277, 281, 384, 386, 389, 393, 512, 514, 517, 521, 640, 642, 645, 649,
      752,  754,  757,  761,  848,  850,  853,  857,  97,   100,  104,  108,  177,  180,  184,  188,  273, 276,  280, 284, 385, 388, 392, 396, 513, 516, 520, 524, 641, 644, 648, 652, 753, 756,
      760,  764,  849,  852,  856,  860,  99,   103,  107,  110,  179,  183,  187,  190,  275,  279,  283, 286,  387, 391, 395, 398, 515, 519, 523, 526, 643, 647, 651, 654, 755, 759, 763, 766,
      851,  855,  859,  862,  102,  106,  109,  111,  182,  186,  189,  191,  278,  282,  285,  287,  390, 394,  397, 399, 518, 522, 525, 527, 646, 650, 653, 655, 758, 762, 765, 767, 854, 858,
      861,  863,  160,  162,  165,  169,  256,  258,  261,  265,  368,  370,  373,  377,  496,  498,  501, 505,  624, 626, 629, 633, 736, 738, 741, 745, 832, 834, 837, 841, 912, 914, 917, 921,
      161,  164,  168,  172,  257,  260,  264,  268,  369,  372,  376,  380,  497,  500,  504,  508,  625, 628,  632, 636, 737, 740, 744, 748, 833, 836, 840, 844, 913, 916, 920, 924, 163, 167,
      171,  174,  259,  263,  267,  270,  371,  375,  379,  382,  499,  503,  507,  510,  627,  631,  635, 638,  739, 743, 747, 750, 835, 839, 843, 846, 915, 919, 923, 926, 166, 170, 173, 175,
      262,  266,  269,  271,  374,  378,  381,  383,  502,  506,  509,  511,  630,  634,  637,  639,  742, 746,  749, 751, 838, 842, 845, 847, 918, 922, 925, 927, 240, 242, 245, 249, 352, 354,
      357,  361,  480,  482,  485,  489,  608,  610,  613,  617,  720,  722,  725,  729,  816,  818,  821, 825,  896, 898, 901, 905, 960, 962, 965, 969, 241, 244, 248, 252, 353, 356, 360, 364,
      481,  484,  488,  492,  609,  612,  616,  620,  721,  724,  728,  732,  817,  820,  824,  828,  897, 900,  904, 908, 961, 964, 968, 972, 243, 247, 251, 254, 355, 359, 363, 366, 483, 487,
      491,  494,  611,  615,  619,  622,  723,  727,  731,  734,  819,  823,  827,  830,  899,  903,  907, 910,  963, 967, 971, 974, 246, 250, 253, 255, 358, 362, 365, 367, 486, 490, 493, 495,
      614,  618,  621,  623,  726,  730,  733,  735,  822,  826,  829,  831,  902,  906,  909,  911,  966, 970,  973, 975, 336, 338, 341, 345, 464, 466, 469, 473, 592, 594, 597, 601, 704, 706,
      709,  713,  800,  802,  805,  809,  880,  882,  885,  889,  944,  946,  949,  953,  992,  994,  997, 1001, 337, 340, 344, 348, 465, 468, 472, 476, 593, 596, 600, 604, 705, 708, 712, 716,
      801,  804,  808,  812,  881,  884,  888,  892,  945,  948,  952,  956,  993,  996,  1000, 1004, 339, 343,  347, 350, 467, 471, 475, 478, 595, 599, 603, 606, 707, 711, 715, 718, 803, 807,
      811,  814,  883,  887,  891,  894,  947,  951,  955,  958,  995,  999,  1003, 1006, 342,  346,  349, 351,  470, 474, 477, 479, 598, 602, 605, 607, 710, 714, 717, 719, 806, 810, 813, 815,
      886,  890,  893,  895,  950,  954,  957,  959,  998,  1002, 1005, 1007, 448,  450,  453,  457,  576, 578,  581, 585, 688, 690, 693, 697, 784, 786, 789, 793, 864, 866, 869, 873, 928, 930,
      933,  937,  976,  978,  981,  985,  1008, 1010, 1013, 1017, 449,  452,  456,  460,  577,  580,  584, 588,  689, 692, 696, 700, 785, 788, 792, 796, 865, 868, 872, 876, 929, 932, 936, 940,
      977,  980,  984,  988,  1009, 1012, 1016, 1020, 451,  455,  459,  462,  579,  583,  587,  590,  691, 695,  699, 702, 787, 791, 795, 798, 867, 871, 875, 878, 931, 935, 939, 942, 979, 983,
      987,  990,  1011, 1015, 1019, 1022, 454,  458,  461,  463,  582,  586,  589,  591,  694,  698,  701, 703,  790, 794, 797, 799, 870, 874, 877, 879, 934, 938, 941, 943, 982, 986, 989, 991,
      1014, 1018, 1021, 1023,
  };
  static const uint_10 inv_g_sig_last_scan_1[1364] = {
      0,    1,    2,    3,    0,    1,    2,    3,    4,   5,   6,   7,   8,   9,   10,  11,  12,  13,  14,  15,  0,   1,   2,   3,   16,  17,  18,   19,   4,    5,    6,    7,    20,   21,   22,
      23,   8,    9,    10,   11,   24,   25,   26,   27,  12,  13,  14,  15,  28,  29,  30,  31,  32,  33,  34,  35,  48,  49,  50,  51,  36,  37,   38,   39,   52,   53,   54,   55,   40,   41,
      42,   43,   56,   57,   58,   59,   44,   45,   46,  47,  60,  61,  62,  63,  0,   1,   2,   3,   16,  17,  18,  19,  32,  33,  34,  35,  48,   49,   50,   51,   4,    5,    6,    7,    20,
      21,   22,   23,   36,   37,   38,   39,   52,   53,  54,  55,  8,   9,   10,  11,  24,  25,  26,  27,  40,  41,  42,  43,  56,  57,  58,  59,   12,   13,   14,   15,   28,   29,   30,   31,
      44,   45,   46,   47,   60,   61,   62,   63,   64,  65,  66,  67,  80,  81,  82,  83,  96,  97,  98,  99,  112, 113, 114, 115, 68,  69,  70,   71,   84,   85,   86,   87,   100,  101,  102,
      103,  116,  117,  118,  119,  72,   73,   74,   75,  88,  89,  90,  91,  104, 105, 106, 107, 120, 121, 122, 123, 76,  77,  78,  79,  92,  93,   94,   95,   108,  109,  110,  111,  124,  125,
      126,  127,  128,  129,  130,  131,  144,  145,  146, 147, 160, 161, 162, 163, 176, 177, 178, 179, 132, 133, 134, 135, 148, 149, 150, 151, 164,  165,  166,  167,  180,  181,  182,  183,  136,
      137,  138,  139,  152,  153,  154,  155,  168,  169, 170, 171, 184, 185, 186, 187, 140, 141, 142, 143, 156, 157, 158, 159, 172, 173, 174, 175,  188,  189,  190,  191,  192,  193,  194,  195,
      208,  209,  210,  211,  224,  225,  226,  227,  240, 241, 242, 243, 196, 197, 198, 199, 212, 213, 214, 215, 228, 229, 230, 231, 244, 245, 246,  247,  200,  201,  202,  203,  216,  217,  218,
      219,  232,  233,  234,  235,  248,  249,  250,  251, 204, 205, 206, 207, 220, 221, 222, 223, 236, 237, 238, 239, 252, 253, 254, 255, 0,   1,    2,    3,    16,   17,   18,   19,   32,   33,
      34,   35,   48,   49,   50,   51,   64,   65,   66,  67,  80,  81,  82,  83,  96,  97,  98,  99,  112, 113, 114, 115, 4,   5,   6,   7,   20,   21,   22,   23,   36,   37,   38,   39,   52,
      53,   54,   55,   68,   69,   70,   71,   84,   85,  86,  87,  100, 101, 102, 103, 116, 117, 118, 119, 8,   9,   10,  11,  24,  25,  26,  27,   40,   41,   42,   43,   56,   57,   58,   59,
      72,   73,   74,   75,   88,   89,   90,   91,   104, 105, 106, 107, 120, 121, 122, 123, 12,  13,  14,  15,  28,  29,  30,  31,  44,  45,  46,   47,   60,   61,   62,   63,   76,   77,   78,
      79,   92,   93,   94,   95,   108,  109,  110,  111, 124, 125, 126, 127, 128, 129, 130, 131, 144, 145, 146, 147, 160, 161, 162, 163, 176, 177,  178,  179,  192,  193,  194,  195,  208,  209,
      210,  211,  224,  225,  226,  227,  240,  241,  242, 243, 132, 133, 134, 135, 148, 149, 150, 151, 164, 165, 166, 167, 180, 181, 182, 183, 196,  197,  198,  199,  212,  213,  214,  215,  228,
      229,  230,  231,  244,  245,  246,  247,  136,  137, 138, 139, 152, 153, 154, 155, 168, 169, 170, 171, 184, 185, 186, 187, 200, 201, 202, 203,  216,  217,  218,  219,  232,  233,  234,  235,
      248,  249,  250,  251,  140,  141,  142,  143,  156, 157, 158, 159, 172, 173, 174, 175, 188, 189, 190, 191, 204, 205, 206, 207, 220, 221, 222,  223,  236,  237,  238,  239,  252,  253,  254,
      255,  256,  257,  258,  259,  272,  273,  274,  275, 288, 289, 290, 291, 304, 305, 306, 307, 320, 321, 322, 323, 336, 337, 338, 339, 352, 353,  354,  355,  368,  369,  370,  371,  260,  261,
      262,  263,  276,  277,  278,  279,  292,  293,  294, 295, 308, 309, 310, 311, 324, 325, 326, 327, 340, 341, 342, 343, 356, 357, 358, 359, 372,  373,  374,  375,  264,  265,  266,  267,  280,
      281,  282,  283,  296,  297,  298,  299,  312,  313, 314, 315, 328, 329, 330, 331, 344, 345, 346, 347, 360, 361, 362, 363, 376, 377, 378, 379,  268,  269,  270,  271,  284,  285,  286,  287,
      300,  301,  302,  303,  316,  317,  318,  319,  332, 333, 334, 335, 348, 349, 350, 351, 364, 365, 366, 367, 380, 381, 382, 383, 384, 385, 386,  387,  400,  401,  402,  403,  416,  417,  418,
      419,  432,  433,  434,  435,  448,  449,  450,  451, 464, 465, 466, 467, 480, 481, 482, 483, 496, 497, 498, 499, 388, 389, 390, 391, 404, 405,  406,  407,  420,  421,  422,  423,  436,  437,
      438,  439,  452,  453,  454,  455,  468,  469,  470, 471, 484, 485, 486, 487, 500, 501, 502, 503, 392, 393, 394, 395, 408, 409, 410, 411, 424,  425,  426,  427,  440,  441,  442,  443,  456,
      457,  458,  459,  472,  473,  474,  475,  488,  489, 490, 491, 504, 505, 506, 507, 396, 397, 398, 399, 412, 413, 414, 415, 428, 429, 430, 431,  444,  445,  446,  447,  460,  461,  462,  463,
      476,  477,  478,  479,  492,  493,  494,  495,  508, 509, 510, 511, 512, 513, 514, 515, 528, 529, 530, 531, 544, 545, 546, 547, 560, 561, 562,  563,  576,  577,  578,  579,  592,  593,  594,
      595,  608,  609,  610,  611,  624,  625,  626,  627, 516, 517, 518, 519, 532, 533, 534, 535, 548, 549, 550, 551, 564, 565, 566, 567, 580, 581,  582,  583,  596,  597,  598,  599,  612,  613,
      614,  615,  628,  629,  630,  631,  520,  521,  522, 523, 536, 537, 538, 539, 552, 553, 554, 555, 568, 569, 570, 571, 584, 585, 586, 587, 600,  601,  602,  603,  616,  617,  618,  619,  632,
      633,  634,  635,  524,  525,  526,  527,  540,  541, 542, 543, 556, 557, 558, 559, 572, 573, 574, 575, 588, 589, 590, 591, 604, 605, 606, 607,  620,  621,  622,  623,  636,  637,  638,  639,
      640,  641,  642,  643,  656,  657,  658,  659,  672, 673, 674, 675, 688, 689, 690, 691, 704, 705, 706, 707, 720, 721, 722, 723, 736, 737, 738,  739,  752,  753,  754,  755,  644,  645,  646,
      647,  660,  661,  662,  663,  676,  677,  678,  679, 692, 693, 694, 695, 708, 709, 710, 711, 724, 725, 726, 727, 740, 741, 742, 743, 756, 757,  758,  759,  648,  649,  650,  651,  664,  665,
      666,  667,  680,  681,  682,  683,  696,  697,  698, 699, 712, 713, 714, 715, 728, 729, 730, 731, 744, 745, 746, 747, 760, 761, 762, 763, 652,  653,  654,  655,  668,  669,  670,  671,  684,
      685,  686,  687,  700,  701,  702,  703,  716,  717, 718, 719, 732, 733, 734, 735, 748, 749, 750, 751, 764, 765, 766, 767, 768, 769, 770, 771,  784,  785,  786,  787,  800,  801,  802,  803,
      816,  817,  818,  819,  832,  833,  834,  835,  848, 849, 850, 851, 864, 865, 866, 867, 880, 881, 882, 883, 772, 773, 774, 775, 788, 789, 790,  791,  804,  805,  806,  807,  820,  821,  822,
      823,  836,  837,  838,  839,  852,  853,  854,  855, 868, 869, 870, 871, 884, 885, 886, 887, 776, 777, 778, 779, 792, 793, 794, 795, 808, 809,  810,  811,  824,  825,  826,  827,  840,  841,
      842,  843,  856,  857,  858,  859,  872,  873,  874, 875, 888, 889, 890, 891, 780, 781, 782, 783, 796, 797, 798, 799, 812, 813, 814, 815, 828,  829,  830,  831,  844,  845,  846,  847,  860,
      861,  862,  863,  876,  877,  878,  879,  892,  893, 894, 895, 896, 897, 898, 899, 912, 913, 914, 915, 928, 929, 930, 931, 944, 945, 946, 947,  960,  961,  962,  963,  976,  977,  978,  979,
      992,  993,  994,  995,  1008, 1009, 1010, 1011, 900, 901, 902, 903, 916, 917, 918, 919, 932, 933, 934, 935, 948, 949, 950, 951, 964, 965, 966,  967,  980,  981,  982,  983,  996,  997,  998,
      999,  1012, 1013, 1014, 1015, 904,  905,  906,  907, 920, 921, 922, 923, 936, 937, 938, 939, 952, 953, 954, 955, 968, 969, 970, 971, 984, 985,  986,  987,  1000, 1001, 1002, 1003, 1016, 1017,
      1018, 1019, 908,  909,  910,  911,  924,  925,  926, 927, 940, 941, 942, 943, 956, 957, 958, 959, 972, 973, 974, 975, 988, 989, 990, 991, 1004, 1005, 1006, 1007, 1020, 1021, 1022, 1023,
  };
  static const uint_10 inv_g_sig_last_scan_2[1364] = {
      0,    2,    1,    3,    0,    4,    8,    12,   1,    5,    9,    13,   2,    6,    10,   14,   3,    7,    11,  15,  0,   4,   8,   12,  32,  36,  40,  44,  1,   5,   9,   13,  33,  37,
      41,   45,   2,    6,    10,   14,   34,   38,   42,   46,   3,    7,    11,   15,   35,   39,   43,   47,   16,  20,  24,  28,  48,  52,  56,  60,  17,  21,  25,  29,  49,  53,  57,  61,
      18,   22,   26,   30,   50,   54,   58,   62,   19,   23,   27,   31,   51,   55,   59,   63,   0,    4,    8,   12,  64,  68,  72,  76,  128, 132, 136, 140, 192, 196, 200, 204, 1,   5,
      9,    13,   65,   69,   73,   77,   129,  133,  137,  141,  193,  197,  201,  205,  2,    6,    10,   14,   66,  70,  74,  78,  130, 134, 138, 142, 194, 198, 202, 206, 3,   7,   11,  15,
      67,   71,   75,   79,   131,  135,  139,  143,  195,  199,  203,  207,  16,   20,   24,   28,   80,   84,   88,  92,  144, 148, 152, 156, 208, 212, 216, 220, 17,  21,  25,  29,  81,  85,
      89,   93,   145,  149,  153,  157,  209,  213,  217,  221,  18,   22,   26,   30,   82,   86,   90,   94,   146, 150, 154, 158, 210, 214, 218, 222, 19,  23,  27,  31,  83,  87,  91,  95,
      147,  151,  155,  159,  211,  215,  219,  223,  32,   36,   40,   44,   96,   100,  104,  108,  160,  164,  168, 172, 224, 228, 232, 236, 33,  37,  41,  45,  97,  101, 105, 109, 161, 165,
      169,  173,  225,  229,  233,  237,  34,   38,   42,   46,   98,   102,  106,  110,  162,  166,  170,  174,  226, 230, 234, 238, 35,  39,  43,  47,  99,  103, 107, 111, 163, 167, 171, 175,
      227,  231,  235,  239,  48,   52,   56,   60,   112,  116,  120,  124,  176,  180,  184,  188,  240,  244,  248, 252, 49,  53,  57,  61,  113, 117, 121, 125, 177, 181, 185, 189, 241, 245,
      249,  253,  50,   54,   58,   62,   114,  118,  122,  126,  178,  182,  186,  190,  242,  246,  250,  254,  51,  55,  59,  63,  115, 119, 123, 127, 179, 183, 187, 191, 243, 247, 251, 255,
      0,    4,    8,    12,   128,  132,  136,  140,  256,  260,  264,  268,  384,  388,  392,  396,  512,  516,  520, 524, 640, 644, 648, 652, 768, 772, 776, 780, 896, 900, 904, 908, 1,   5,
      9,    13,   129,  133,  137,  141,  257,  261,  265,  269,  385,  389,  393,  397,  513,  517,  521,  525,  641, 645, 649, 653, 769, 773, 777, 781, 897, 901, 905, 909, 2,   6,   10,  14,
      130,  134,  138,  142,  258,  262,  266,  270,  386,  390,  394,  398,  514,  518,  522,  526,  642,  646,  650, 654, 770, 774, 778, 782, 898, 902, 906, 910, 3,   7,   11,  15,  131, 135,
      139,  143,  259,  263,  267,  271,  387,  391,  395,  399,  515,  519,  523,  527,  643,  647,  651,  655,  771, 775, 779, 783, 899, 903, 907, 911, 16,  20,  24,  28,  144, 148, 152, 156,
      272,  276,  280,  284,  400,  404,  408,  412,  528,  532,  536,  540,  656,  660,  664,  668,  784,  788,  792, 796, 912, 916, 920, 924, 17,  21,  25,  29,  145, 149, 153, 157, 273, 277,
      281,  285,  401,  405,  409,  413,  529,  533,  537,  541,  657,  661,  665,  669,  785,  789,  793,  797,  913, 917, 921, 925, 18,  22,  26,  30,  146, 150, 154, 158, 274, 278, 282, 286,
      402,  406,  410,  414,  530,  534,  538,  542,  658,  662,  666,  670,  786,  790,  794,  798,  914,  918,  922, 926, 19,  23,  27,  31,  147, 151, 155, 159, 275, 279, 283, 287, 403, 407,
      411,  415,  531,  535,  539,  543,  659,  663,  667,  671,  787,  791,  795,  799,  915,  919,  923,  927,  32,  36,  40,  44,  160, 164, 168, 172, 288, 292, 296, 300, 416, 420, 424, 428,
      544,  548,  552,  556,  672,  676,  680,  684,  800,  804,  808,  812,  928,  932,  936,  940,  33,   37,   41,  45,  161, 165, 169, 173, 289, 293, 297, 301, 417, 421, 425, 429, 545, 549,
      553,  557,  673,  677,  681,  685,  801,  805,  809,  813,  929,  933,  937,  941,  34,   38,   42,   46,   162, 166, 170, 174, 290, 294, 298, 302, 418, 422, 426, 430, 546, 550, 554, 558,
      674,  678,  682,  686,  802,  806,  810,  814,  930,  934,  938,  942,  35,   39,   43,   47,   163,  167,  171, 175, 291, 295, 299, 303, 419, 423, 427, 431, 547, 551, 555, 559, 675, 679,
      683,  687,  803,  807,  811,  815,  931,  935,  939,  943,  48,   52,   56,   60,   176,  180,  184,  188,  304, 308, 312, 316, 432, 436, 440, 444, 560, 564, 568, 572, 688, 692, 696, 700,
      816,  820,  824,  828,  944,  948,  952,  956,  49,   53,   57,   61,   177,  181,  185,  189,  305,  309,  313, 317, 433, 437, 441, 445, 561, 565, 569, 573, 689, 693, 697, 701, 817, 821,
      825,  829,  945,  949,  953,  957,  50,   54,   58,   62,   178,  182,  186,  190,  306,  310,  314,  318,  434, 438, 442, 446, 562, 566, 570, 574, 690, 694, 698, 702, 818, 822, 826, 830,
      946,  950,  954,  958,  51,   55,   59,   63,   179,  183,  187,  191,  307,  311,  315,  319,  435,  439,  443, 447, 563, 567, 571, 575, 691, 695, 699, 703, 819, 823, 827, 831, 947, 951,
      955,  959,  64,   68,   72,   76,   192,  196,  200,  204,  320,  324,  328,  332,  448,  452,  456,  460,  576, 580, 584, 588, 704, 708, 712, 716, 832, 836, 840, 844, 960, 964, 968, 972,
      65,   69,   73,   77,   193,  197,  201,  205,  321,  325,  329,  333,  449,  453,  457,  461,  577,  581,  585, 589, 705, 709, 713, 717, 833, 837, 841, 845, 961, 965, 969, 973, 66,  70,
      74,   78,   194,  198,  202,  206,  322,  326,  330,  334,  450,  454,  458,  462,  578,  582,  586,  590,  706, 710, 714, 718, 834, 838, 842, 846, 962, 966, 970, 974, 67,  71,  75,  79,
      195,  199,  203,  207,  323,  327,  331,  335,  451,  455,  459,  463,  579,  583,  587,  591,  707,  711,  715, 719, 835, 839, 843, 847, 963, 967, 971, 975, 80,  84,  88,  92,  208, 212,
      216,  220,  336,  340,  344,  348,  464,  468,  472,  476,  592,  596,  600,  604,  720,  724,  728,  732,  848, 852, 856, 860, 976, 980, 984, 988, 81,  85,  89,  93,  209, 213, 217, 221,
      337,  341,  345,  349,  465,  469,  473,  477,  593,  597,  601,  605,  721,  725,  729,  733,  849,  853,  857, 861, 977, 981, 985, 989, 82,  86,  90,  94,  210, 214, 218, 222, 338, 342,
      346,  350,  466,  470,  474,  478,  594,  598,  602,  606,  722,  726,  730,  734,  850,  854,  858,  862,  978, 982, 986, 990, 83,  87,  91,  95,  211, 215, 219, 223, 339, 343, 347, 351,
      467,  471,  475,  479,  595,  599,  603,  607,  723,  727,  731,  735,  851,  855,  859,  863,  979,  983,  987, 991, 96,  100, 104, 108, 224, 228, 232, 236, 352, 356, 360, 364, 480, 484,
      488,  492,  608,  612,  616,  620,  736,  740,  744,  748,  864,  868,  872,  876,  992,  996,  1000, 1004, 97,  101, 105, 109, 225, 229, 233, 237, 353, 357, 361, 365, 481, 485, 489, 493,
      609,  613,  617,  621,  737,  741,  745,  749,  865,  869,  873,  877,  993,  997,  1001, 1005, 98,   102,  106, 110, 226, 230, 234, 238, 354, 358, 362, 366, 482, 486, 490, 494, 610, 614,
      618,  622,  738,  742,  746,  750,  866,  870,  874,  878,  994,  998,  1002, 1006, 99,   103,  107,  111,  227, 231, 235, 239, 355, 359, 363, 367, 483, 487, 491, 495, 611, 615, 619, 623,
      739,  743,  747,  751,  867,  871,  875,  879,  995,  999,  1003, 1007, 112,  116,  120,  124,  240,  244,  248, 252, 368, 372, 376, 380, 496, 500, 504, 508, 624, 628, 632, 636, 752, 756,
      760,  764,  880,  884,  888,  892,  1008, 1012, 1016, 1020, 113,  117,  121,  125,  241,  245,  249,  253,  369, 373, 377, 381, 497, 501, 505, 509, 625, 629, 633, 637, 753, 757, 761, 765,
      881,  885,  889,  893,  1009, 1013, 1017, 1021, 114,  118,  122,  126,  242,  246,  250,  254,  370,  374,  378, 382, 498, 502, 506, 510, 626, 630, 634, 638, 754, 758, 762, 766, 882, 886,
      890,  894,  1010, 1014, 1018, 1022, 115,  119,  123,  127,  243,  247,  251,  255,  371,  375,  379,  383,  499, 503, 507, 511, 627, 631, 635, 639, 755, 759, 763, 767, 883, 887, 891, 895,
      1011, 1015, 1019, 1023,
  };

  static const uint_10 inv_g_sig_last_scan[3][1364] = {
      {
          0,    2,    1,    3,    0,    2,    5,    9,    1,    4,    8,    12,   3,    7,    11,   14,   6,   10,   13,  15,  0,   2,   5,   9,   32,  34,  37,  41,  1,   4,   8,   12,  33,  36,
          40,   44,   3,    7,    11,   14,   35,   39,   43,   46,   6,    10,   13,   15,   38,   42,   45,  47,   16,  18,  21,  25,  48,  50,  53,  57,  17,  20,  24,  28,  49,  52,  56,  60,
          19,   23,   27,   30,   51,   55,   59,   62,   22,   26,   29,   31,   54,   58,   61,   63,   0,   2,    5,   9,   32,  34,  37,  41,  80,  82,  85,  89,  144, 146, 149, 153, 1,   4,
          8,    12,   33,   36,   40,   44,   81,   84,   88,   92,   145,  148,  152,  156,  3,    7,    11,  14,   35,  39,  43,  46,  83,  87,  91,  94,  147, 151, 155, 158, 6,   10,  13,  15,
          38,   42,   45,   47,   86,   90,   93,   95,   150,  154,  157,  159,  16,   18,   21,   25,   64,  66,   69,  73,  128, 130, 133, 137, 192, 194, 197, 201, 17,  20,  24,  28,  65,  68,
          72,   76,   129,  132,  136,  140,  193,  196,  200,  204,  19,   23,   27,   30,   67,   71,   75,  78,   131, 135, 139, 142, 195, 199, 203, 206, 22,  26,  29,  31,  70,  74,  77,  79,
          134,  138,  141,  143,  198,  202,  205,  207,  48,   50,   53,   57,   112,  114,  117,  121,  176, 178,  181, 185, 224, 226, 229, 233, 49,  52,  56,  60,  113, 116, 120, 124, 177, 180,
          184,  188,  225,  228,  232,  236,  51,   55,   59,   62,   115,  119,  123,  126,  179,  183,  187, 190,  227, 231, 235, 238, 54,  58,  61,  63,  118, 122, 125, 127, 182, 186, 189, 191,
          230,  234,  237,  239,  96,   98,   101,  105,  160,  162,  165,  169,  208,  210,  213,  217,  240, 242,  245, 249, 97,  100, 104, 108, 161, 164, 168, 172, 209, 212, 216, 220, 241, 244,
          248,  252,  99,   103,  107,  110,  163,  167,  171,  174,  211,  215,  219,  222,  243,  247,  251, 254,  102, 106, 109, 111, 166, 170, 173, 175, 214, 218, 221, 223, 246, 250, 253, 255,
          0,    2,    5,    9,    32,   34,   37,   41,   80,   82,   85,   89,   144,  146,  149,  153,  224, 226,  229, 233, 320, 322, 325, 329, 432, 434, 437, 441, 560, 562, 565, 569, 1,   4,
          8,    12,   33,   36,   40,   44,   81,   84,   88,   92,   145,  148,  152,  156,  225,  228,  232, 236,  321, 324, 328, 332, 433, 436, 440, 444, 561, 564, 568, 572, 3,   7,   11,  14,
          35,   39,   43,   46,   83,   87,   91,   94,   147,  151,  155,  158,  227,  231,  235,  238,  323, 327,  331, 334, 435, 439, 443, 446, 563, 567, 571, 574, 6,   10,  13,  15,  38,  42,
          45,   47,   86,   90,   93,   95,   150,  154,  157,  159,  230,  234,  237,  239,  326,  330,  333, 335,  438, 442, 445, 447, 566, 570, 573, 575, 16,  18,  21,  25,  64,  66,  69,  73,
          128,  130,  133,  137,  208,  210,  213,  217,  304,  306,  309,  313,  416,  418,  421,  425,  544, 546,  549, 553, 672, 674, 677, 681, 17,  20,  24,  28,  65,  68,  72,  76,  129, 132,
          136,  140,  209,  212,  216,  220,  305,  308,  312,  316,  417,  420,  424,  428,  545,  548,  552, 556,  673, 676, 680, 684, 19,  23,  27,  30,  67,  71,  75,  78,  131, 135, 139, 142,
          211,  215,  219,  222,  307,  311,  315,  318,  419,  423,  427,  430,  547,  551,  555,  558,  675, 679,  683, 686, 22,  26,  29,  31,  70,  74,  77,  79,  134, 138, 141, 143, 214, 218,
          221,  223,  310,  314,  317,  319,  422,  426,  429,  431,  550,  554,  557,  559,  678,  682,  685, 687,  48,  50,  53,  57,  112, 114, 117, 121, 192, 194, 197, 201, 288, 290, 293, 297,
          400,  402,  405,  409,  528,  530,  533,  537,  656,  658,  661,  665,  768,  770,  773,  777,  49,  52,   56,  60,  113, 116, 120, 124, 193, 196, 200, 204, 289, 292, 296, 300, 401, 404,
          408,  412,  529,  532,  536,  540,  657,  660,  664,  668,  769,  772,  776,  780,  51,   55,   59,  62,   115, 119, 123, 126, 195, 199, 203, 206, 291, 295, 299, 302, 403, 407, 411, 414,
          531,  535,  539,  542,  659,  663,  667,  670,  771,  775,  779,  782,  54,   58,   61,   63,   118, 122,  125, 127, 198, 202, 205, 207, 294, 298, 301, 303, 406, 410, 413, 415, 534, 538,
          541,  543,  662,  666,  669,  671,  774,  778,  781,  783,  96,   98,   101,  105,  176,  178,  181, 185,  272, 274, 277, 281, 384, 386, 389, 393, 512, 514, 517, 521, 640, 642, 645, 649,
          752,  754,  757,  761,  848,  850,  853,  857,  97,   100,  104,  108,  177,  180,  184,  188,  273, 276,  280, 284, 385, 388, 392, 396, 513, 516, 520, 524, 641, 644, 648, 652, 753, 756,
          760,  764,  849,  852,  856,  860,  99,   103,  107,  110,  179,  183,  187,  190,  275,  279,  283, 286,  387, 391, 395, 398, 515, 519, 523, 526, 643, 647, 651, 654, 755, 759, 763, 766,
          851,  855,  859,  862,  102,  106,  109,  111,  182,  186,  189,  191,  278,  282,  285,  287,  390, 394,  397, 399, 518, 522, 525, 527, 646, 650, 653, 655, 758, 762, 765, 767, 854, 858,
          861,  863,  160,  162,  165,  169,  256,  258,  261,  265,  368,  370,  373,  377,  496,  498,  501, 505,  624, 626, 629, 633, 736, 738, 741, 745, 832, 834, 837, 841, 912, 914, 917, 921,
          161,  164,  168,  172,  257,  260,  264,  268,  369,  372,  376,  380,  497,  500,  504,  508,  625, 628,  632, 636, 737, 740, 744, 748, 833, 836, 840, 844, 913, 916, 920, 924, 163, 167,
          171,  174,  259,  263,  267,  270,  371,  375,  379,  382,  499,  503,  507,  510,  627,  631,  635, 638,  739, 743, 747, 750, 835, 839, 843, 846, 915, 919, 923, 926, 166, 170, 173, 175,
          262,  266,  269,  271,  374,  378,  381,  383,  502,  506,  509,  511,  630,  634,  637,  639,  742, 746,  749, 751, 838, 842, 845, 847, 918, 922, 925, 927, 240, 242, 245, 249, 352, 354,
          357,  361,  480,  482,  485,  489,  608,  610,  613,  617,  720,  722,  725,  729,  816,  818,  821, 825,  896, 898, 901, 905, 960, 962, 965, 969, 241, 244, 248, 252, 353, 356, 360, 364,
          481,  484,  488,  492,  609,  612,  616,  620,  721,  724,  728,  732,  817,  820,  824,  828,  897, 900,  904, 908, 961, 964, 968, 972, 243, 247, 251, 254, 355, 359, 363, 366, 483, 487,
          491,  494,  611,  615,  619,  622,  723,  727,  731,  734,  819,  823,  827,  830,  899,  903,  907, 910,  963, 967, 971, 974, 246, 250, 253, 255, 358, 362, 365, 367, 486, 490, 493, 495,
          614,  618,  621,  623,  726,  730,  733,  735,  822,  826,  829,  831,  902,  906,  909,  911,  966, 970,  973, 975, 336, 338, 341, 345, 464, 466, 469, 473, 592, 594, 597, 601, 704, 706,
          709,  713,  800,  802,  805,  809,  880,  882,  885,  889,  944,  946,  949,  953,  992,  994,  997, 1001, 337, 340, 344, 348, 465, 468, 472, 476, 593, 596, 600, 604, 705, 708, 712, 716,
          801,  804,  808,  812,  881,  884,  888,  892,  945,  948,  952,  956,  993,  996,  1000, 1004, 339, 343,  347, 350, 467, 471, 475, 478, 595, 599, 603, 606, 707, 711, 715, 718, 803, 807,
          811,  814,  883,  887,  891,  894,  947,  951,  955,  958,  995,  999,  1003, 1006, 342,  346,  349, 351,  470, 474, 477, 479, 598, 602, 605, 607, 710, 714, 717, 719, 806, 810, 813, 815,
          886,  890,  893,  895,  950,  954,  957,  959,  998,  1002, 1005, 1007, 448,  450,  453,  457,  576, 578,  581, 585, 688, 690, 693, 697, 784, 786, 789, 793, 864, 866, 869, 873, 928, 930,
          933,  937,  976,  978,  981,  985,  1008, 1010, 1013, 1017, 449,  452,  456,  460,  577,  580,  584, 588,  689, 692, 696, 700, 785, 788, 792, 796, 865, 868, 872, 876, 929, 932, 936, 940,
          977,  980,  984,  988,  1009, 1012, 1016, 1020, 451,  455,  459,  462,  579,  583,  587,  590,  691, 695,  699, 702, 787, 791, 795, 798, 867, 871, 875, 878, 931, 935, 939, 942, 979, 983,
          987,  990,  1011, 1015, 1019, 1022, 454,  458,  461,  463,  582,  586,  589,  591,  694,  698,  701, 703,  790, 794, 797, 799, 870, 874, 877, 879, 934, 938, 941, 943, 982, 986, 989, 991,
          1014, 1018, 1021, 1023,
      },
      {
          0,    1,    2,    3,    0,    1,    2,    3,    4,    5,    6,   7,   8,   9,   10,  11,  12,  13,  14,  15,  0,   1,   2,   3,   16,  17,  18,  19,  4,   5,   6,    7,    20,   21,
          22,   23,   8,    9,    10,   11,   24,   25,   26,   27,   12,  13,  14,  15,  28,  29,  30,  31,  32,  33,  34,  35,  48,  49,  50,  51,  36,  37,  38,  39,  52,   53,   54,   55,
          40,   41,   42,   43,   56,   57,   58,   59,   44,   45,   46,  47,  60,  61,  62,  63,  0,   1,   2,   3,   16,  17,  18,  19,  32,  33,  34,  35,  48,  49,  50,   51,   4,    5,
          6,    7,    20,   21,   22,   23,   36,   37,   38,   39,   52,  53,  54,  55,  8,   9,   10,  11,  24,  25,  26,  27,  40,  41,  42,  43,  56,  57,  58,  59,  12,   13,   14,   15,
          28,   29,   30,   31,   44,   45,   46,   47,   60,   61,   62,  63,  64,  65,  66,  67,  80,  81,  82,  83,  96,  97,  98,  99,  112, 113, 114, 115, 68,  69,  70,   71,   84,   85,
          86,   87,   100,  101,  102,  103,  116,  117,  118,  119,  72,  73,  74,  75,  88,  89,  90,  91,  104, 105, 106, 107, 120, 121, 122, 123, 76,  77,  78,  79,  92,   93,   94,   95,
          108,  109,  110,  111,  124,  125,  126,  127,  128,  129,  130, 131, 144, 145, 146, 147, 160, 161, 162, 163, 176, 177, 178, 179, 132, 133, 134, 135, 148, 149, 150,  151,  164,  165,
          166,  167,  180,  181,  182,  183,  136,  137,  138,  139,  152, 153, 154, 155, 168, 169, 170, 171, 184, 185, 186, 187, 140, 141, 142, 143, 156, 157, 158, 159, 172,  173,  174,  175,
          188,  189,  190,  191,  192,  193,  194,  195,  208,  209,  210, 211, 224, 225, 226, 227, 240, 241, 242, 243, 196, 197, 198, 199, 212, 213, 214, 215, 228, 229, 230,  231,  244,  245,
          246,  247,  200,  201,  202,  203,  216,  217,  218,  219,  232, 233, 234, 235, 248, 249, 250, 251, 204, 205, 206, 207, 220, 221, 222, 223, 236, 237, 238, 239, 252,  253,  254,  255,
          0,    1,    2,    3,    16,   17,   18,   19,   32,   33,   34,  35,  48,  49,  50,  51,  64,  65,  66,  67,  80,  81,  82,  83,  96,  97,  98,  99,  112, 113, 114,  115,  4,    5,
          6,    7,    20,   21,   22,   23,   36,   37,   38,   39,   52,  53,  54,  55,  68,  69,  70,  71,  84,  85,  86,  87,  100, 101, 102, 103, 116, 117, 118, 119, 8,    9,    10,   11,
          24,   25,   26,   27,   40,   41,   42,   43,   56,   57,   58,  59,  72,  73,  74,  75,  88,  89,  90,  91,  104, 105, 106, 107, 120, 121, 122, 123, 12,  13,  14,   15,   28,   29,
          30,   31,   44,   45,   46,   47,   60,   61,   62,   63,   76,  77,  78,  79,  92,  93,  94,  95,  108, 109, 110, 111, 124, 125, 126, 127, 128, 129, 130, 131, 144,  145,  146,  147,
          160,  161,  162,  163,  176,  177,  178,  179,  192,  193,  194, 195, 208, 209, 210, 211, 224, 225, 226, 227, 240, 241, 242, 243, 132, 133, 134, 135, 148, 149, 150,  151,  164,  165,
          166,  167,  180,  181,  182,  183,  196,  197,  198,  199,  212, 213, 214, 215, 228, 229, 230, 231, 244, 245, 246, 247, 136, 137, 138, 139, 152, 153, 154, 155, 168,  169,  170,  171,
          184,  185,  186,  187,  200,  201,  202,  203,  216,  217,  218, 219, 232, 233, 234, 235, 248, 249, 250, 251, 140, 141, 142, 143, 156, 157, 158, 159, 172, 173, 174,  175,  188,  189,
          190,  191,  204,  205,  206,  207,  220,  221,  222,  223,  236, 237, 238, 239, 252, 253, 254, 255, 256, 257, 258, 259, 272, 273, 274, 275, 288, 289, 290, 291, 304,  305,  306,  307,
          320,  321,  322,  323,  336,  337,  338,  339,  352,  353,  354, 355, 368, 369, 370, 371, 260, 261, 262, 263, 276, 277, 278, 279, 292, 293, 294, 295, 308, 309, 310,  311,  324,  325,
          326,  327,  340,  341,  342,  343,  356,  357,  358,  359,  372, 373, 374, 375, 264, 265, 266, 267, 280, 281, 282, 283, 296, 297, 298, 299, 312, 313, 314, 315, 328,  329,  330,  331,
          344,  345,  346,  347,  360,  361,  362,  363,  376,  377,  378, 379, 268, 269, 270, 271, 284, 285, 286, 287, 300, 301, 302, 303, 316, 317, 318, 319, 332, 333, 334,  335,  348,  349,
          350,  351,  364,  365,  366,  367,  380,  381,  382,  383,  384, 385, 386, 387, 400, 401, 402, 403, 416, 417, 418, 419, 432, 433, 434, 435, 448, 449, 450, 451, 464,  465,  466,  467,
          480,  481,  482,  483,  496,  497,  498,  499,  388,  389,  390, 391, 404, 405, 406, 407, 420, 421, 422, 423, 436, 437, 438, 439, 452, 453, 454, 455, 468, 469, 470,  471,  484,  485,
          486,  487,  500,  501,  502,  503,  392,  393,  394,  395,  408, 409, 410, 411, 424, 425, 426, 427, 440, 441, 442, 443, 456, 457, 458, 459, 472, 473, 474, 475, 488,  489,  490,  491,
          504,  505,  506,  507,  396,  397,  398,  399,  412,  413,  414, 415, 428, 429, 430, 431, 444, 445, 446, 447, 460, 461, 462, 463, 476, 477, 478, 479, 492, 493, 494,  495,  508,  509,
          510,  511,  512,  513,  514,  515,  528,  529,  530,  531,  544, 545, 546, 547, 560, 561, 562, 563, 576, 577, 578, 579, 592, 593, 594, 595, 608, 609, 610, 611, 624,  625,  626,  627,
          516,  517,  518,  519,  532,  533,  534,  535,  548,  549,  550, 551, 564, 565, 566, 567, 580, 581, 582, 583, 596, 597, 598, 599, 612, 613, 614, 615, 628, 629, 630,  631,  520,  521,
          522,  523,  536,  537,  538,  539,  552,  553,  554,  555,  568, 569, 570, 571, 584, 585, 586, 587, 600, 601, 602, 603, 616, 617, 618, 619, 632, 633, 634, 635, 524,  525,  526,  527,
          540,  541,  542,  543,  556,  557,  558,  559,  572,  573,  574, 575, 588, 589, 590, 591, 604, 605, 606, 607, 620, 621, 622, 623, 636, 637, 638, 639, 640, 641, 642,  643,  656,  657,
          658,  659,  672,  673,  674,  675,  688,  689,  690,  691,  704, 705, 706, 707, 720, 721, 722, 723, 736, 737, 738, 739, 752, 753, 754, 755, 644, 645, 646, 647, 660,  661,  662,  663,
          676,  677,  678,  679,  692,  693,  694,  695,  708,  709,  710, 711, 724, 725, 726, 727, 740, 741, 742, 743, 756, 757, 758, 759, 648, 649, 650, 651, 664, 665, 666,  667,  680,  681,
          682,  683,  696,  697,  698,  699,  712,  713,  714,  715,  728, 729, 730, 731, 744, 745, 746, 747, 760, 761, 762, 763, 652, 653, 654, 655, 668, 669, 670, 671, 684,  685,  686,  687,
          700,  701,  702,  703,  716,  717,  718,  719,  732,  733,  734, 735, 748, 749, 750, 751, 764, 765, 766, 767, 768, 769, 770, 771, 784, 785, 786, 787, 800, 801, 802,  803,  816,  817,
          818,  819,  832,  833,  834,  835,  848,  849,  850,  851,  864, 865, 866, 867, 880, 881, 882, 883, 772, 773, 774, 775, 788, 789, 790, 791, 804, 805, 806, 807, 820,  821,  822,  823,
          836,  837,  838,  839,  852,  853,  854,  855,  868,  869,  870, 871, 884, 885, 886, 887, 776, 777, 778, 779, 792, 793, 794, 795, 808, 809, 810, 811, 824, 825, 826,  827,  840,  841,
          842,  843,  856,  857,  858,  859,  872,  873,  874,  875,  888, 889, 890, 891, 780, 781, 782, 783, 796, 797, 798, 799, 812, 813, 814, 815, 828, 829, 830, 831, 844,  845,  846,  847,
          860,  861,  862,  863,  876,  877,  878,  879,  892,  893,  894, 895, 896, 897, 898, 899, 912, 913, 914, 915, 928, 929, 930, 931, 944, 945, 946, 947, 960, 961, 962,  963,  976,  977,
          978,  979,  992,  993,  994,  995,  1008, 1009, 1010, 1011, 900, 901, 902, 903, 916, 917, 918, 919, 932, 933, 934, 935, 948, 949, 950, 951, 964, 965, 966, 967, 980,  981,  982,  983,
          996,  997,  998,  999,  1012, 1013, 1014, 1015, 904,  905,  906, 907, 920, 921, 922, 923, 936, 937, 938, 939, 952, 953, 954, 955, 968, 969, 970, 971, 984, 985, 986,  987,  1000, 1001,
          1002, 1003, 1016, 1017, 1018, 1019, 908,  909,  910,  911,  924, 925, 926, 927, 940, 941, 942, 943, 956, 957, 958, 959, 972, 973, 974, 975, 988, 989, 990, 991, 1004, 1005, 1006, 1007,
          1020, 1021, 1022, 1023,
      },
      {
          0,    2,    1,    3,    0,    4,    8,    12,   1,    5,    9,    13,   2,    6,    10,   14,   3,    7,    11,  15,  0,   4,   8,   12,  32,  36,  40,  44,  1,   5,   9,   13,  33,  37,
          41,   45,   2,    6,    10,   14,   34,   38,   42,   46,   3,    7,    11,   15,   35,   39,   43,   47,   16,  20,  24,  28,  48,  52,  56,  60,  17,  21,  25,  29,  49,  53,  57,  61,
          18,   22,   26,   30,   50,   54,   58,   62,   19,   23,   27,   31,   51,   55,   59,   63,   0,    4,    8,   12,  64,  68,  72,  76,  128, 132, 136, 140, 192, 196, 200, 204, 1,   5,
          9,    13,   65,   69,   73,   77,   129,  133,  137,  141,  193,  197,  201,  205,  2,    6,    10,   14,   66,  70,  74,  78,  130, 134, 138, 142, 194, 198, 202, 206, 3,   7,   11,  15,
          67,   71,   75,   79,   131,  135,  139,  143,  195,  199,  203,  207,  16,   20,   24,   28,   80,   84,   88,  92,  144, 148, 152, 156, 208, 212, 216, 220, 17,  21,  25,  29,  81,  85,
          89,   93,   145,  149,  153,  157,  209,  213,  217,  221,  18,   22,   26,   30,   82,   86,   90,   94,   146, 150, 154, 158, 210, 214, 218, 222, 19,  23,  27,  31,  83,  87,  91,  95,
          147,  151,  155,  159,  211,  215,  219,  223,  32,   36,   40,   44,   96,   100,  104,  108,  160,  164,  168, 172, 224, 228, 232, 236, 33,  37,  41,  45,  97,  101, 105, 109, 161, 165,
          169,  173,  225,  229,  233,  237,  34,   38,   42,   46,   98,   102,  106,  110,  162,  166,  170,  174,  226, 230, 234, 238, 35,  39,  43,  47,  99,  103, 107, 111, 163, 167, 171, 175,
          227,  231,  235,  239,  48,   52,   56,   60,   112,  116,  120,  124,  176,  180,  184,  188,  240,  244,  248, 252, 49,  53,  57,  61,  113, 117, 121, 125, 177, 181, 185, 189, 241, 245,
          249,  253,  50,   54,   58,   62,   114,  118,  122,  126,  178,  182,  186,  190,  242,  246,  250,  254,  51,  55,  59,  63,  115, 119, 123, 127, 179, 183, 187, 191, 243, 247, 251, 255,
          0,    4,    8,    12,   128,  132,  136,  140,  256,  260,  264,  268,  384,  388,  392,  396,  512,  516,  520, 524, 640, 644, 648, 652, 768, 772, 776, 780, 896, 900, 904, 908, 1,   5,
          9,    13,   129,  133,  137,  141,  257,  261,  265,  269,  385,  389,  393,  397,  513,  517,  521,  525,  641, 645, 649, 653, 769, 773, 777, 781, 897, 901, 905, 909, 2,   6,   10,  14,
          130,  134,  138,  142,  258,  262,  266,  270,  386,  390,  394,  398,  514,  518,  522,  526,  642,  646,  650, 654, 770, 774, 778, 782, 898, 902, 906, 910, 3,   7,   11,  15,  131, 135,
          139,  143,  259,  263,  267,  271,  387,  391,  395,  399,  515,  519,  523,  527,  643,  647,  651,  655,  771, 775, 779, 783, 899, 903, 907, 911, 16,  20,  24,  28,  144, 148, 152, 156,
          272,  276,  280,  284,  400,  404,  408,  412,  528,  532,  536,  540,  656,  660,  664,  668,  784,  788,  792, 796, 912, 916, 920, 924, 17,  21,  25,  29,  145, 149, 153, 157, 273, 277,
          281,  285,  401,  405,  409,  413,  529,  533,  537,  541,  657,  661,  665,  669,  785,  789,  793,  797,  913, 917, 921, 925, 18,  22,  26,  30,  146, 150, 154, 158, 274, 278, 282, 286,
          402,  406,  410,  414,  530,  534,  538,  542,  658,  662,  666,  670,  786,  790,  794,  798,  914,  918,  922, 926, 19,  23,  27,  31,  147, 151, 155, 159, 275, 279, 283, 287, 403, 407,
          411,  415,  531,  535,  539,  543,  659,  663,  667,  671,  787,  791,  795,  799,  915,  919,  923,  927,  32,  36,  40,  44,  160, 164, 168, 172, 288, 292, 296, 300, 416, 420, 424, 428,
          544,  548,  552,  556,  672,  676,  680,  684,  800,  804,  808,  812,  928,  932,  936,  940,  33,   37,   41,  45,  161, 165, 169, 173, 289, 293, 297, 301, 417, 421, 425, 429, 545, 549,
          553,  557,  673,  677,  681,  685,  801,  805,  809,  813,  929,  933,  937,  941,  34,   38,   42,   46,   162, 166, 170, 174, 290, 294, 298, 302, 418, 422, 426, 430, 546, 550, 554, 558,
          674,  678,  682,  686,  802,  806,  810,  814,  930,  934,  938,  942,  35,   39,   43,   47,   163,  167,  171, 175, 291, 295, 299, 303, 419, 423, 427, 431, 547, 551, 555, 559, 675, 679,
          683,  687,  803,  807,  811,  815,  931,  935,  939,  943,  48,   52,   56,   60,   176,  180,  184,  188,  304, 308, 312, 316, 432, 436, 440, 444, 560, 564, 568, 572, 688, 692, 696, 700,
          816,  820,  824,  828,  944,  948,  952,  956,  49,   53,   57,   61,   177,  181,  185,  189,  305,  309,  313, 317, 433, 437, 441, 445, 561, 565, 569, 573, 689, 693, 697, 701, 817, 821,
          825,  829,  945,  949,  953,  957,  50,   54,   58,   62,   178,  182,  186,  190,  306,  310,  314,  318,  434, 438, 442, 446, 562, 566, 570, 574, 690, 694, 698, 702, 818, 822, 826, 830,
          946,  950,  954,  958,  51,   55,   59,   63,   179,  183,  187,  191,  307,  311,  315,  319,  435,  439,  443, 447, 563, 567, 571, 575, 691, 695, 699, 703, 819, 823, 827, 831, 947, 951,
          955,  959,  64,   68,   72,   76,   192,  196,  200,  204,  320,  324,  328,  332,  448,  452,  456,  460,  576, 580, 584, 588, 704, 708, 712, 716, 832, 836, 840, 844, 960, 964, 968, 972,
          65,   69,   73,   77,   193,  197,  201,  205,  321,  325,  329,  333,  449,  453,  457,  461,  577,  581,  585, 589, 705, 709, 713, 717, 833, 837, 841, 845, 961, 965, 969, 973, 66,  70,
          74,   78,   194,  198,  202,  206,  322,  326,  330,  334,  450,  454,  458,  462,  578,  582,  586,  590,  706, 710, 714, 718, 834, 838, 842, 846, 962, 966, 970, 974, 67,  71,  75,  79,
          195,  199,  203,  207,  323,  327,  331,  335,  451,  455,  459,  463,  579,  583,  587,  591,  707,  711,  715, 719, 835, 839, 843, 847, 963, 967, 971, 975, 80,  84,  88,  92,  208, 212,
          216,  220,  336,  340,  344,  348,  464,  468,  472,  476,  592,  596,  600,  604,  720,  724,  728,  732,  848, 852, 856, 860, 976, 980, 984, 988, 81,  85,  89,  93,  209, 213, 217, 221,
          337,  341,  345,  349,  465,  469,  473,  477,  593,  597,  601,  605,  721,  725,  729,  733,  849,  853,  857, 861, 977, 981, 985, 989, 82,  86,  90,  94,  210, 214, 218, 222, 338, 342,
          346,  350,  466,  470,  474,  478,  594,  598,  602,  606,  722,  726,  730,  734,  850,  854,  858,  862,  978, 982, 986, 990, 83,  87,  91,  95,  211, 215, 219, 223, 339, 343, 347, 351,
          467,  471,  475,  479,  595,  599,  603,  607,  723,  727,  731,  735,  851,  855,  859,  863,  979,  983,  987, 991, 96,  100, 104, 108, 224, 228, 232, 236, 352, 356, 360, 364, 480, 484,
          488,  492,  608,  612,  616,  620,  736,  740,  744,  748,  864,  868,  872,  876,  992,  996,  1000, 1004, 97,  101, 105, 109, 225, 229, 233, 237, 353, 357, 361, 365, 481, 485, 489, 493,
          609,  613,  617,  621,  737,  741,  745,  749,  865,  869,  873,  877,  993,  997,  1001, 1005, 98,   102,  106, 110, 226, 230, 234, 238, 354, 358, 362, 366, 482, 486, 490, 494, 610, 614,
          618,  622,  738,  742,  746,  750,  866,  870,  874,  878,  994,  998,  1002, 1006, 99,   103,  107,  111,  227, 231, 235, 239, 355, 359, 363, 367, 483, 487, 491, 495, 611, 615, 619, 623,
          739,  743,  747,  751,  867,  871,  875,  879,  995,  999,  1003, 1007, 112,  116,  120,  124,  240,  244,  248, 252, 368, 372, 376, 380, 496, 500, 504, 508, 624, 628, 632, 636, 752, 756,
          760,  764,  880,  884,  888,  892,  1008, 1012, 1016, 1020, 113,  117,  121,  125,  241,  245,  249,  253,  369, 373, 377, 381, 497, 501, 505, 509, 625, 629, 633, 637, 753, 757, 761, 765,
          881,  885,  889,  893,  1009, 1013, 1017, 1021, 114,  118,  122,  126,  242,  246,  250,  254,  370,  374,  378, 382, 498, 502, 506, 510, 626, 630, 634, 638, 754, 758, 762, 766, 882, 886,
          890,  894,  1010, 1014, 1018, 1022, 115,  119,  123,  127,  243,  247,  251,  255,  371,  375,  379,  383,  499, 503, 507, 511, 627, 631, 635, 639, 755, 759, 763, 767, 883, 887, 891, 895,
          1011, 1015, 1019, 1023,
      }};

  return inv_g_sig_last_scan[scan_mode][cord + offset[size]];
}

#pragma hls_design
void get_coeff_cost(coeff_port_t &coeff_in, coeff_port_t &coeff_out) {
  // Read input
  const conf_t conf(coeff_in.read());

  const two_bit size = conf.size();
  const two_bit scan_mode = get_scan_order(conf.intra_mode, conf.depth);

  // Parameters for linear model.
  uint_7 nonzero_cg_count[2] = {0, 0};
  uint_10 scan_i_last[2] = {0, 0};

  uint_7 comb_nonzero_cg_count = 0;
  uint_10 comb_scan_i_last = 0;

  uint_32 cost[2] = {0, 0};
  one_bit has_coeffs[2] = {0, 0};

  ac_int< CG_COUNT > coeff_group[2] = {0, 0};

  // Iterate over the residual in scan order in order to find the position of
  // the last significant coeff and to count the number of nonzero coeff groups.

#pragma hls_pipeline_init_interval 1
  for (uint_6 y = 0; y < MAX_WIDTH; ++y) {
    coeff_slice_t coeffs = coeff_in.read();
    coeff_out.write(coeffs);

  dual_op:
#pragma hls_unroll yes
    for (two_bit r = 0; r < 2; ++r) {
      uint_20 coeff_sum_slice = 0;
      uint_16 zero_coeff_count_slice = 0;
      uint_16 one_coeff_count_slice = 0;
      uint_10 scan_i_slice[16];

    slice_half:
#pragma hls_unroll yes
      for (uint_6 x = 0; x < 16; ++x) {
        uint_16 coeff_abs = ctl::Abs< 16 >(coeffs.slc< 16 >(16 * ((16 * r) + x)));

        uint_10 cord = y * 32 + ((16 * r) + x) - (r && size == 3 ? 16 : 0);
        uint_10 i = scan_i(cord, size, scan_mode);

        coeff_sum_slice += coeff_abs;
        scan_i_slice[x] = coeff_abs ? i : uint_10(0);

        if (coeff_abs) {
          if (coeff_abs == 1) {
            one_coeff_count_slice[x] = 1;
          }

          coeff_group[r][i >> 4] = 1;
        } else {
          zero_coeff_count_slice[x] = 1;
        }
      }
      uint_32 cost_temp = ((DFITS_TO_INT(dfits[size][1 - 1]) * coeff_sum_slice.slc< 4 >(0)) + ((DFITS_TO_INT(dfits[size][1 - 1]) << 4) * (coeff_sum_slice >> 4)) +
                           (DFITS_TO_INT(dfits[size][2 - 1]) * ctl::Ones< 16 >(zero_coeff_count_slice)) + (DFITS_TO_INT(dfits[size][3 - 1]) * ctl::Ones< 16 >(one_coeff_count_slice)));

      cost[r] += 2 * cost_temp;

      has_coeffs[r] |= one_bit(coeff_sum_slice != 0);
      scan_i_last[r] = MAX(scan_i_last[r], ctl::Max< 16 >(scan_i_slice));
    }
    if (y == loops[0][size])
      break;
  }

  nonzero_cg_count[0] += ctl::Ones< CG_COUNT >(coeff_group[0]);
  nonzero_cg_count[1] += ctl::Ones< CG_COUNT >(coeff_group[1]);

  comb_scan_i_last = MAX(scan_i_last[0], scan_i_last[1]);
  comb_nonzero_cg_count += ctl::Ones< CG_COUNT >(coeff_group[0] | coeff_group[1]);

  coeff_slice_t output = 0;

dual_cost:
#pragma hls_unroll yes
  for (two_bit r = 0; r < 2; ++r) {
    uint_32 bits = FITS_TO_INT(fits[size][0]) + cost[r];
    uint_32 bits_temp = (DFITS_TO_INT(dfits[size][4 - 1]) * nonzero_cg_count[r] + DFITS_TO_INT(dfits[size][5 - 1]) * scan_i_last[r]);

    output.set_slc(32 * (r + 1), has_coeffs[r] ? (uint_32)(bits + 2 * bits_temp) : uint_32(0));
  }

  uint_32 bits = FITS_TO_INT(fits[size][0]) + cost[0] + cost[1];
  uint_32 bits_temp = ((DFITS_TO_INT(dfits[size][4 - 1]) * comb_nonzero_cg_count) + (DFITS_TO_INT(dfits[size][5 - 1]) * comb_scan_i_last));

  output.set_slc(0, (has_coeffs[0] | has_coeffs[1]) ? (uint_32)(bits + 2 * bits_temp) : uint_32(0));
  coeff_out.write(output);
}

#pragma hls_design top
void main_coeff_cost(coeff_port_t &coeff_in, coeff_port_t &coeff_out, int_16 trans_push[SIZE_MULT * MAX_WIDTH][MAX_WIDTH], int_16 trans_pull[SIZE_MULT * MAX_WIDTH][MAX_WIDTH]) {
  static coeff_port_t coeff_trans;

  coeff_transpose_pipe(coeff_in, coeff_trans, trans_push, trans_pull);
  get_coeff_cost(coeff_trans, coeff_out);
}
